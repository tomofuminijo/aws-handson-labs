# パブリックサブネットを一つもつVPC を作成する

このハンズオンでは、最もシンプルなパブリックサブネットを一つだけ持つVPC を作成します。その後、VPC 内にEC2 インスタンスを起動しインターネットからアクセスできることを確認します。

## AWS 料金
- 12ヶ月無料利用枠内で実施できます。

## 前提条件
- マネジメントコンソールにログインできること
- VPC および EC2 サービスへのアクセス権限があること

## 作成するアーキテクチャ

![アーキテクチャ](images/simple_vpc_architecture.png)

一つの **VPC** (CIDR: 10.0.0.0/16) を作成し、一つの **サブネット** (CIDR: 10.0.0.0/24) を作成します。
インターネットと通信するために **インターネットゲートウェイ (IGW)** を作成し、**サブネット** に関連づく **ルートテーブル (Route Table)** に **IGW** への経路を定義します。
その後、作成した **Subnet** に　Web Server となる **EC2 インスタンス** を起動し、**セキュリティグループ** によりHTTP 通信で
利用する80 番ポートを許可します。Web Server 構築は **ユーザデータ** により実施します。最後にインターネットからアクセスできることを確認します。


## 用語解説
- VPC
- サブネット
- CIDR
- インターネットゲートウェイ (IGW)
- ルートテーブル
- セキュリティグループ
- ユーザデータ
 
## 手順概要
- Task1: 東京リージョンにVPC を作成し、サブネットを作成する
- Task2: インターネットゲートウェイを作成し、VPC にアタッチする
- Task3: ルートテーブルを作成し、インターネットゲートウェイへの経路を追加し、サブネットにアタッチする
- Task4: EC2 インスタンスを作成したサブネット内に起動する
  - ユーザデータによりWeb Server を自動構成
  - セキュリティグループにより80 番ポートを許可
- Task5: ブラウザからEC2 インスタンスにアクセスしてみる


## ラボ実施時の注意点
AWS マネジメントコンソールは頻繁に更新されるため、ラボ手順と画面の内容が異なる可能性があります。ボタン名など英語表記になっていたりもします。その場合は、適宜手順を読み替えてください。現在の手順が何の目的で実施しているのかを絶えず意識すると多少画面に変化があっても対応できます。


##  Task1: 東京リージョンにVPC を作成し、サブネットを作成する

1. **マネジメントコンソール** にログインする
     - https://console.aws.amazon.com
  
2.  画面右上で、リージョンが、**東京** になっていることを確認する。異なるリージョンであれば、**東京** を選択する(なお東京以外のリージョンでも実施可能です。) 
3. 画面左上の**サービス** から **VPC** を選択する
4. 画面左側のナビゲーションペインにて、**VPC** を選択する
5.  **Create VPC** ボタンをクリックする(VPC ダッシュボード画面上の**Create VPC** ボタンではありませんのでご注意ください)
6. **VPC 作成** 画面にて、以下の内容を入力します。これ以外はデフォルトのままとしておきます。
   - 名前タグ: `LabVPC`
   - IPv4 CIDR blocブロック: `10.0.0.0/16`

7. **作成** ボタンをクリックします。
8. **VPC が作成されました** 画面で **閉じる** ボタンをクリックします。VPC の作成は以上です。
9. 左側のナビゲーションペインにて、**サブネット** をクリックします。
10. **サブネットの作成** ボタンをクリックします。
11. **サブネットの作成** 画面にて、以下の内容を入力します。
    - 名前タグ: `PublicSubnet`
    - VPC: `LabVPC` を選択
    - アベイラビリティゾーン: `ap-northeast-1a` (東京リージョン以外の場合は先頭のAZ を選択)
    - IPv4 CIDR ブロック: `10.0.0.0/24

12. **作成** ボタンをクリックします。
13. **次のサブネットが作成されました** 画面で **閉じる** ボタンをクリックします。

以上、VPC と サブネットの作成が完了しました。



##  Task2: インターネットゲートウェイを作成し、VPC にアタッチする

1. ナビゲーションペインにて、**インターネットゲートウェイ** をクリックします。
   
2. **インターネットゲートウェイの作成** ボタンをクリックします。
3. **インターネットゲートウェイの作成** 画面にて、**Name タグ** に `LabIGW` と入力します。
4. **作成** ボタンをクリックします。
5. **次のインターネットゲートウェイが作成されました** 画面で **閉じる** ボタンをクリックします。
6. 一覧に **LabIGW** が存在していることを確認します。もし存在していない場合は、一覧右上の更新(円形の２本の矢印)ボタンをクリックしててください。
7. 次に、作成したIGW を **LabVPC** にアタッチします。一覧上で、**LabIGW** のチェックボックスにチェックを入れます。
8. **アクション** をクリックして **VPC にアタッチ** を選択します。
9.  **VPC** で `LabVPC` を選択し、**アタッチ** ボタンをクリックします。

    Task2　は以上です。


##  Task3: ルートテーブルを作成し、インターネットゲートウェイへの経路を追加し、サブネットにアタッチする

1. ナビゲーションペインにて、**ルートテーブル** をクリックします。

2. **ルートテーブルの作成** ボタンをクリックします。
3. **ルートテーブルの作成** 画面にて、以下の内容を入力します。
   - 名前タグ: `PublicRT`
   - VPC: `LabVPC` を選択
4. **作成** ボタンをクリックします。
5. **次のルートテーブルが作成されました** 画面で **閉じる** ボタンをクリックします。
6. 一覧に `PublicRT` が表示されていることを確認します。
7. 一覧で `PublicRT` のチェックボックスにチェックを入れて **アクション** から **ルートの編集** をクリックします。
8. **ルートの編集** 画面にて、**ルートの追加** ボタンをクリックします。
9. 以下の内容を入力します。
    - 宛先(Destination): `0.0.0.0/0`
    - ターゲット: `Internet Gateway` をクリックして、`LabIGW` を選択

10. **ルートの保存** ボタンをクリックします。
11. **ルートの編集が成功しました** 画面で **閉じる**　ボタンをクリックします。
12. 一覧で、**PublicRT** にチェックが入った状態で再度 **アクション** をクリックし、**サブネットの関連を編集** をクリックします。
13. **サブネットの関連を編集** 画面で、`PublicSubnet` にチェックを入れて **保存**　ボタンをクリックします。

    Task3 は以上です。


##  Task4: EC2 インスタンスを作成したサブネット内に起動する

ここまでで、必要なVPC の構成は完了しました。次に先ほど作成した`PublicSubnet` にEC2 インスタンスを起動します。

1. マネジメントコンソールの **サービス** から **EC2** を選択します。
   
2. 画面左のナビゲーションペインにて **インスタンス** をクリックします。
3. **インスタンスの作成** ボタンをクリックします。
4. **手順 1: Amazon マシンイメージ (AMI)** 画面にて、一番上に表示されている **Amazon Linux 2 AMI (HVM), SSD Volume Type** の横の **選択** ボタンをクリックします。(必ず一番上の Amazon Linux **2** を選択してください。)
5. **手順 2: インスタンスタイプの選択** 画面ではデフォルトの **t2.micro** が選択されたままで、**次の手順: インスタンスの詳細の設定** をクリックします。
6. **手順 3: インスタンスの詳細の設定** 画面にて、以下の内容を入力します。記載がないものはデフォルトのままとしておきます。
   - ネットワーク: `LabVPC`
   - サブネット: `PublicSubnet` (自動選択される)
   - 自動割り当てパブリック IP: `有効` 
7. 画面を下にスクロールして、**高度な詳細** 部分を展開します。
8. **ユーザデータ** のテキストエリアに以下の内容をコピー＆ペースとします。
    ```
    #!/bin/bash
    yum -y install httpd
    systemctl enable httpd.service
    systemctl start httpd.service
    wget http://nijot-training.s3.amazonaws.com/demo/html/index.html -O /var/www/html/index.html
    ```

9. **次の手順: ストレージの追加** をクリックします。
10. **手順 4: ストレージの追加** 画面では何も変更せずに、**次の手順: タグの追加** をクリックします。
11. **手順 5: タグの追加** 画面で **タグの追加** ボタンをクリックし、以下を入力します。
    - キー: `Name` (大文字小文字を区別)
    - 値: `LabWebServer`
12. **次の手順: セキュイティグループの設定** ボタンをクリックします。
13. **手順 6: セキュリティグループの設定** 画面にて、以下の内容を入力します。
    
    |||
    |---|---|---|
    |セキュリティグループの割り当て|**新しいセキュリティグループを作成する** にチェック（デフォルトのまま)|
    |セキュリティグループ名|`LabWebSG`|
    |説明|`Web Server Security Group`| 

14. 下の一覧の既存の `SSH` 列は今回利用しないため、列右側の **×**　ボタンをクリックして削除します。
15. **ルールの追加** ボタンをクリックして、以下の内容を入力します。
    |||
    |---|---|---|
    |タイプ|`HTTP`|
    |ソース|`任意の場所`|

    画面下側に22番ポートが開いていないという警告が出ますが、今回はSSH アクセスしないため無視して構いません。

16. **確認と作成** ボタンをクリックします。
17. **手順 7: インスタンス作成の確認** 画面で、**起動** ボタンをクリックします。
18. **既存のキーペアを選択するか、新しいキーペアを作成します。**　画面にて **キーペアの選択** を **キーペアなしで続行** に変更し、**このAMI に組み込まれたパスワードが…（略)…** にチェクを入れて、**インスタンスの作成** ボタンをクリックします。
19. **作成ステータス** 画面にて、**インスタンスの表示** ボタンをクリックします。
20. 一覧中に **LabWebServer** が表示されていることを確認します。


##  Task5: ブラウザからEC2 インスタンスにアクセスしてみる

1. 起動するまで２分ほど時間がかかります。一覧の **LabWebServer** の **ステータス** が　**running** になったことを確認します。
2. 一覧で **LabWebServer** にチェックを入れて、一覧下に表示される **パブリックIP** をコピーします。
3. ブラウザで別のタブを開いて、アドレスバーにコピーしたIP アドレスを貼り付けてキーボードのEnter を押します。
4. **Welcom to AWS!!** 画面が表示されたら正常に動作しています。

## 終了処理

１２ヶ月間無料利用枠の中には、今回起動した **t2.micro** インスタンスの月当たり 750 時間分の無料利用枠がありますが、複数のインスタンスを起動している場合などに、起動し続けておくと課金される場合がありますので、不要であれば削除します。   
なお、VPC は課金されませんので残しておいて問題ありません。

1. **LabWebServer** にチェックを入れた状態で、**アクション** をクリックし、**インスタンスの状態** > **終了** をクリックします。
2. **インスタンスの削除** 画面で、**はい、削除する** をクリックします。
3. **インスタンスの状態** が **shutting-down** になり、しばらく(1-2分)すると **terminated** に変わります。
4. **terminated**　状態になったら課金されません。**terminated** 状態のインスタンスはしばらく一覧上に残りますが、数時間後に消えますので放置しておきましょう。



このハンズオンは以上です。
